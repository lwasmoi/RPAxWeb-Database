<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5; 
            --secondary-bg: #f3f4f6;
        }
        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--secondary-bg);
            color: #333;
        }
        
        /* Navbar Styling */
        .navbar {
            background: white !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color) !important;
        }
        .nav-link {
            font-weight: 500;
            color: #555 !important;
            margin-right: 15px;
            transition: color 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color) !important;
        }
        
        /* Card & UI */
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white;
            transition: transform 0.2s;
        }
        .card-header {
            background: transparent;
            border-bottom: 1px solid #eee;
            padding: 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .card-body {
            padding: 1.5rem;
        }
        .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        /*  Loading Screen แบบใหม่ (พื้นหลังใส) */
        #global-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: transparent; 
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
          
        }
        
    
        .loader-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .spinner-custom {
            width: 3rem; 
            height: 3rem;
            border-width: 0.25em;
        }
    </style>
</head>
<body>
    <div id="global-loader">
        <div class="loader-box">
            <div class="spinner-border text-primary spinner-custom mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h6 class="text-primary fw-bold m-0">รอสักครู่...</h6>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-database-fill-gear me-2"></i>KB Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/funds"><i class="bi bi-cash-coin me-1"></i> Funds</a></li>
                    <li class="nav-item"><a class="nav-link" href="/glossary"><i class="bi bi-book me-1"></i> Glossary</a></li>
                    <li class="nav-item"><a class="nav-link" href="/documents"><i class="bi bi-file-text me-1"></i> Docs</a></li>
                    <li class="nav-item"><a class="nav-link" href="/categories"><i class="bi bi-tags me-1"></i> Cats</a></li>
                    <li class="nav-item"><a class="nav-link" href="/manuals"><i class="bi bi-journal-text me-1"></i> Manuals</a></li>
                    <li class="nav-item"><a class="nav-link" href="/stories"><i class="bi bi-chat-square-quote me-1"></i> Stories</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm border-0 rounded-3 mb-4" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                            <div>{{ message }}</div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const loader = document.getElementById('global-loader');

            window.addEventListener('pageshow', function(event) {
                if (event.persisted) { 
                    loader.style.display = 'none';
                    document.querySelectorAll('button[type="submit"]').forEach(btn => {
                        btn.disabled = false;
                        if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
                    });
                }
            });

            document.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    const target = this.getAttribute('target');
                    if (href && !href.startsWith('#') && !href.startsWith('javascript') && target !== '_blank') {
                        loader.style.display = 'flex';
                    }
                });
            });

            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    if (this.id.startsWith('delete-form-')) return;

                    if (this.checkValidity()) {
                        loader.style.display = 'flex';
                        const btn = this.querySelector('button[type="submit"]');
                        if (btn) {
                            btn.disabled = true;
                            btn.dataset.originalText = btn.innerHTML;
                            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังดำเนินการ...';
                        }
                    }
                });
            });

            const table = document.getElementById('dataTable');
            const searchInput = document.getElementById('searchInput');
            const filterSelect = document.getElementById('filterSelect');

            if (table && (searchInput || filterSelect)) {
                const rows = table.querySelectorAll('tbody tr');
                if (filterSelect) {
                    const columnIndex = parseInt(filterSelect.getAttribute('data-column'));
                    const uniqueValues = new Set();
                    rows.forEach(row => {
                        const cell = row.cells[columnIndex];
                        if (cell) {
                            const value = cell.textContent.trim();
                            if (value) uniqueValues.add(value);
                        }
                    });
                    Array.from(uniqueValues).sort().forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        filterSelect.appendChild(option);
                    });
                }
                function applyFilters() {
                    const searchText = searchInput ? searchInput.value.toLowerCase() : '';
                    const filterValue = filterSelect ? filterSelect.value : 'all';
                    const columnIndex = filterSelect ? parseInt(filterSelect.getAttribute('data-column')) : -1;
                    rows.forEach(row => {
                        let isVisible = true;
                        if (searchText && !row.textContent.toLowerCase().includes(searchText)) isVisible = false;
                        if (isVisible && filterValue !== 'all' && columnIndex !== -1) {
                            const cell = row.cells[columnIndex];
                            if (cell && !cell.textContent.trim().includes(filterValue)) isVisible = false;
                        }
                        row.style.display = isVisible ? '' : 'none';
                    });
                }
                if (searchInput) searchInput.addEventListener('keyup', applyFilters);
                if (filterSelect) filterSelect.addEventListener('change', applyFilters);
            }
        });

        function confirmDelete(id, title = '') {
            Swal.fire({
                title: 'ยืนยันการลบข้อมูล?',
                text: title ? `คุณต้องการลบ "${title}" ใช่หรือไม่? เมื่อลบแล้วจะไม่สามารถกู้คืนได้` : "คุณต้องการลบรายการนี้ใช่หรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', 
                cancelButtonColor: '#6c757d', 
                confirmButtonText: 'ใช่, ลบทิ้งเลย!',
                cancelButtonText: 'ยกเลิก',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // เมื่อกดยืนยัน ค่อยแสดง Loader และส่งฟอร์ม
                    document.getElementById('global-loader').style.display = 'flex';
                    document.getElementById('delete-form-' + id).submit();
                }
            })
        }
    </script>
</body>
</html>